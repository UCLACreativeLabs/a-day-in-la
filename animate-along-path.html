<html>

<head>
	<script src="scripts/pathseg.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg.js"></script>
	<script src="scripts/animatealongpath.js"></script>
	<style type="text/css">
	svg {
		width: 300px;
		height: 300px;
	}
	</style>
</head>

<body>
	<svg id="svg"></svg>
	<script>
	var s = Snap('#svg');
	var circle = s.circle(-10, -10, 10);
	Snap.load('testpath.svg', (imported) => {
		s.append(imported);
		var p = Snap('#path4146'),
			milestones = [],
			animObj = {};

		function reanimate() {
			animObj.anim && animObj.anim.stop();
			circle.transform(''); // initial transformation should be 0
			animateAlongPath(p, circle, 0, 500, milestones, animObj);
		}

		function createMilestone(x, y, length) {
			var elem = s.circle(x, y, 5);

			milestones.push(length);
			milestones.sort();
			elem.appendTo(s);
			elem.click((e) => {
				milestones.splice(milestones.indexOf(length), 1);
				elem.remove();
				e.preventDefault();
				e.stopPropagation();
				reanimate();
			});
			reanimate();
		}

		$("#svg").click(function (e) {
			var mat = p.transform().globalMatrix,
				matinv = mat.invert(),
				offset = [e.offsetX, e.offsetY],
				offsetRel = [matinv.x(...offset), matinv.y(...offset)];

			closest = Snap.closestPoint(p, ...offsetRel);
			if (closest.distance < 5) {
				var pt = [closest.x, closest.y]
				createMilestone(mat.x(...pt), mat.y(...pt), closest.length);
			}

			console.log(closest);
		});

		reanimate();
	});

	</script>
</body>

</html>
